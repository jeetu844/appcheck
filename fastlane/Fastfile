default_platform(:ios)

before_all do
  # You can remove this check if you want to bypass the Git status check
  # ensure_git_status_clean
  git_pull # Pull the latest code
end

platform :ios do
  desc "Increment build number and version"
  lane :update_version do
    plist_version = get_version_number_from_plist(xcodeproj: './ios/AppCheck.xcodeproj')
    UI.message "Bumping patch version"
    increment_version_number_in_plist(xcodeproj: './ios/AppCheck.xcodeproj', bump_type: 'patch')
  end

  desc "Build the .ipa only with manual code signing"
  lane :build_ipa do
    # Increment the build number
    increment_build_number(xcodeproj: './ios/AppCheck.xcodeproj')

    # Build the .ipa using Gym with manual code signing
    gym(
      workspace: './ios/AppCheck.xcworkspace', # Path to your Xcode workspace
      scheme: 'AppCheck', # Your app's scheme
      export_method: 'app-store', # Method for app distribution (app-store, ad-hoc, enterprise)
      output_directory: './build', # Output directory for the .ipa
      output_name: 'AppCheck.ipa', # Name of the generated .ipa file
      codesigning_identity: "iPhone Distribution: HR7RS84V6F", # Team ID
      provisioning_profile_path: "./AppCheckGit_Dis.mobileprovision", # Path to your provisioning profile
      export_options: {
        provisioningProfiles: {
          "HR7RS84V6F.com.appchekongit" => "AppCheckGit_Dis" # Bundle identifier and provisioning profile name
        },
        team_id: "HR7RS84V6F", # Team ID
        signingStyle: "manual"
      }
    )
  end
end
